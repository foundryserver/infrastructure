#=====================================================================
# HAProxy Configuration - K0s Kubernetes Cluster & Ceph RADOS Gateway
#=====================================================================
#
# Purpose:
#   Load balancer for K0s Kubernetes cluster and Ceph object storage
#
# Components:
#   1. K0s Control Plane Load Balancing
#      - Kubernetes API (port 6443)
#      - Konnectivity (port 8132)
#      - Controller Join API (port 9443)
#
#   2. K0s Application NodePort Services
#      - Error API (port 31001)
#      - Email API (port 31002)
#      - K8s API (port 31003)
#      - S3 API (port 31004)
#      - User API (port 31005)
#      - SFTP Server Dev (port 31007)
#      - SFTP Server Prod (port 31008)
#
#   3. Ceph RADOS Gateway (RGW)
#      - S3/Swift object storage API (port 80)
#      - Load balances across 4 Proxmox nodes (pve0-3)
#
# Infrastructure:
#   - K0s Controllers: 10.20.20.201-203
#   - K0s NodePorts: 10.20.20.204-206
#   - Proxmox/Ceph Nodes: 10.20.30.20, 10.20.30.21, 10.20.30.22, 10.20.30.28
#
# Features:
#   - Health checks on all backends
#   - Statistics dashboard on port 9000
#   - HTTP compression for RGW responses
#   - Extended logging for S3 requests
#
# Last Updated: January 14, 2026
#=====================================================================

global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend kubeAPI
    bind :6443
    mode tcp
    default_backend kubeAPI_backend

frontend konnectivity
    bind :8132
    mode tcp
    default_backend konnectivity_backend

frontend controllerJoinAPI
    bind :9443
    mode tcp
    default_backend controllerJoinAPI_backend

frontend errorAPI
    bind :31001
    mode tcp
    default_backend errorAPI_backend

frontend emailAPI
    bind :31002
    mode tcp
    default_backend emailAPI_backend

frontend k8sAPI
    bind :31003
    mode tcp
    default_backend k8sAPI_backend

frontend s3API
    bind :31004
    mode tcp
    default_backend s3API_backend

frontend userAPI
    bind :31005
    mode tcp
    default_backend userAPI_backend

frontend sftpServer-dev
    bind :31007
    mode tcp
    default_backend sftpServer_dev_backend

frontend sftpServer-prod
    bind :31008
    mode tcp
    default_backend sftpServer_prod_backend

#---------------------------------------------------------------------
# RADOS Gateway HTTP Frontend (S3/Swift)
#---------------------------------------------------------------------
frontend rgw_http
    bind *:80
    mode http
    
    # Log format for S3 requests
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    
    # ACLs for S3 API
    acl is_s3 hdr_beg(host) -i s3.
    acl is_s3 path_beg /
    
    # Compression for text responses
    compression algo gzip
    compression type text/html text/plain text/css application/json application/xml
    
    # Use backend
    default_backend rgw_backend

backend kubeAPI_backend
    mode tcp
    server k0s-controller1 10.20.20.201:6443 check check-ssl verify none
    server k0s-controller2 10.20.20.202:6443 check check-ssl verify none
    server k0s-controller3 10.20.20.203:6443 check check-ssl verify none

backend konnectivity_backend
    mode tcp
    server k0s-controller1 10.20.20.201:8132 check check-ssl verify none
    server k0s-controller2 10.20.20.202:8132 check check-ssl verify none
    server k0s-controller3 10.20.20.203:8132 check check-ssl verify none

backend controllerJoinAPI_backend
    mode tcp
    server k0s-controller1 10.20.20.201:9443 check check-ssl verify none
    server k0s-controller2 10.20.20.202:9443 check check-ssl verify none
    server k0s-controller3 10.20.20.203:9443 check check-ssl verify none

backend errorAPI_backend
    mode tcp
    server nodeport1 10.20.20.204:31001 check
    server nodeport2 10.20.20.205:31001 check
    server nodeport3 10.20.20.206:31001 check

backend emailAPI_backend
    mode tcp
    server nodeport1 10.20.20.204:31002 check
    server nodeport2 10.20.20.205:31002 check
    server nodeport3 10.20.20.206:31002 check

backend k8sAPI_backend
    mode tcp
    server nodeport1 10.20.20.204:31003 check
    server nodeport2 10.20.20.205:31003 check
    server nodeport3 10.20.20.206:31003 check

backend s3API_backend
    mode tcp
    server nodeport1 10.20.20.204:31004 check
    server nodeport2 10.20.20.205:31004 check
    server nodeport3 10.20.20.206:31004 check

backend userAPI_backend
    mode tcp
    server nodeport1 10.20.20.204:31005 check
    server nodeport2 10.20.20.205:31005 check
    server nodeport3 10.20.20.206:31005 check

backend sftpServer_dev_backend
    mode tcp
    server nodeport1 10.20.20.204:31007 check
    server nodeport2 10.20.20.205:31007 check
    server nodeport3 10.20.20.206:31007 check

backend sftpServer_prod_backend
    mode tcp
    server nodeport1 10.20.20.204:31008 check
    server nodeport2 10.20.20.205:31008 check
    server nodeport3 10.20.20.206:31008 check

#---------------------------------------------------------------------
# RADOS Gateway Backend Servers
#---------------------------------------------------------------------
backend rgw_backend
    mode http
    balance roundrobin
    
    # Stick table for session persistence (optional for S3)
    # stick-table type ip size 200k expire 30m
    # stick on src
    
    # Health check - simple HTTP GET to root
    option httpchk GET /
    http-check expect status 200
    
    # Server timeout for large uploads
    timeout server 300s
    timeout connect 5s
    
    # RGW servers - 4 nodes in the Ceph cluster
    # Format: server <name> <ip>:<port> check inter <interval> rise <count> fall <count>
    
    server pve0 10.20.30.20:7480 check inter 5s rise 2 fall 3 maxconn 1000
    server pve1 10.20.30.21:7480 check inter 5s rise 2 fall 3 maxconn 1000
    server pve2 10.20.30.22:7480 check inter 5s rise 2 fall 3 maxconn 1000
    server pve3 10.20.30.28:7480 check inter 5s rise 2 fall 3 maxconn 1000
    
    # HTTP headers
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }


listen stats
   bind *:9000
   mode http
   stats enable
   stats uri /
